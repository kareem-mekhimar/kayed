{"version":3,"sources":["../../src/controllers/push-notifications.controller.js"],"names":["validateSubcribtion","req","checkBody","notEmpty","withMessage","custom","value","userSub","findOne","endpoint","relatedUser","user","id","Error","getValidationResult","subscribe","res","next","validationErrors","isEmpty","mapped","params","NotFound","body","create","pushNotification","status","end","unsubscribe","find","remove"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;AACA;;AACA;;;;;;;;AAGA,IAAMA,sBAAsB,SAAtBA,mBAAsB,MAAO;AAC/BC,QAAIC,SAAJ,CAAc,UAAd,EAA0BC,QAA1B,GAAqCC,WAArC,CAAiD,mBAAjD,EAAsEC,MAAtE;AAAA,2EAA6E,iBAAMC,KAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AACrEC,mCADqE,GAC3D,eAAiBC,OAAjB,CAAyB,EAACC,UAAUH,KAAX,EAAkBI,aAAaT,IAAIU,IAAJ,CAASC,EAAxC,EAAzB,CAD2D;;AAAA,iCAErEL,OAFqE;AAAA;AAAA;AAAA;;AAAA,kCAG/D,IAAIM,KAAJ,CAAU,4BAAV,CAH+D;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAA7E;;AAAA;AAAA;AAAA;AAAA,SAIGT,WAJH,CAIe,4BAJf;AAKAH,QAAIC,SAAJ,CAAc,aAAd,EAA6BC,QAA7B,GAAwCC,WAAxC,CAAoD,sBAApD;AACAH,QAAIC,SAAJ,CAAc,WAAd,EAA2BC,QAA3B,GAAsCC,WAAtC,CAAkD,oBAAlD;AACA,WAAOH,IAAIa,mBAAJ,EAAP;AACH,CATD;;kBAWe;AACLC,aADK,qBACKd,GADL,EACUe,GADV,EACeC,IADf,EACqB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACGjB,oBAAoBC,GAApB,CADH;;AAAA;AACtBiB,4CADsB;;AAAA,gCAEvBA,iBAAiBC,OAAjB,EAFuB;AAAA;AAAA;AAAA;;AAAA,8DAGjBF,KAAK,uBAAa,GAAb,EAAkBC,iBAAiBE,MAAjB,EAAlB,CAAL,CAHiB;;AAAA;AAAA;AAAA,mCAKnB,kCAAenB,IAAIoB,MAAJ,CAAWT,EAA1B,CALmB;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,8DAMjBK,KAAK,IAAI,mBAASK,QAAb,CAAsB,MAAtB,CAAL,CANiB;;AAAA;;AAQ5BrB,gCAAIsB,IAAJ,CAASb,WAAT,GAAuBT,IAAIU,IAAJ,CAASC,EAAhC;AAR4B;AAAA;AAAA,mCAUK,eAAiBY,MAAjB,CAAwBvB,IAAIsB,IAA5B,CAVL;;AAAA;AAUpBE,4CAVoB;;AAWxBT,gCAAIU,MAAJ,CAAW,GAAX,EAAgBC,GAAhB;AAXwB;AAAA;;AAAA;AAAA;AAAA;;AAaxBV;;AAbwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAe/B,KAhBU;AAkBLW,eAlBK,uBAkBO3B,GAlBP,EAkBYe,GAlBZ,EAkBiBC,IAlBjB,EAkBuB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCAC3B,kCAAehB,IAAIoB,MAAJ,CAAWT,EAA1B,CAD2B;AAAA;AAAA;AAAA;;AAAA,8DAEnBK,KAAK,IAAI,mBAASK,QAAb,CAAsB,MAAtB,CAAL,CAFmB;;AAAA;AAAA;AAAA,mCAIxB,eAAiBO,IAAjB,CAAsB,EAAEnB,aAAaT,IAAIU,IAAJ,CAASC,EAAxB,EAAtB,EAAmDkB,MAAnD,EAJwB;;AAAA;;AAM9B7B,gCAAIyB,MAAJ,CAAW,GAAX,EAAgBC,GAAhB;;AAN8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOjC;AAzBU,C","file":"push-notifications.controller.js","sourcesContent":["import User from \"../models/user.model\";\nimport OfferMessageNotification from \"../models/offer-message-notification.model\";\nimport { ApiResponse2 } from \"../helpers/ApiResponse\";\nimport ApiError from \"../helpers/ApiError\";\nimport { isUserNotExist } from \"../helpers/CheckMethods\";\nimport PushNotification from '../models/push.model';\n\n\nconst validateSubcribtion = req => {\n    req.checkBody(\"endpoint\").notEmpty().withMessage(\"endpoint required\").custom(async value => { \n        let userSub = PushNotification.findOne({endpoint: value, relatedUser: req.user.id})\n        if (userSub) \n            throw new Error(\"User is already subscribed\");\n    }).withMessage('User is already subscribed');\n    req.checkBody(\"keys.p256dh\").notEmpty().withMessage(\"keys.p256dh required\");\n    req.checkBody(\"keys.auth\").notEmpty().withMessage(\"Keys.auth required\");\n    return req.getValidationResult();\n}\n\nexport default {\n    async subscribe(req, res, next) {\n        const validationErrors = await validateSubcribtion(req);\n        if (!validationErrors.isEmpty())\n            return next(new ApiError(422, validationErrors.mapped()));\n\n        if(await isUserNotExist(req.params.id))\n            return next(new ApiError.NotFound('User'));\n\n        req.body.relatedUser = req.user.id;\n        try {\n            let pushNotification = await PushNotification.create(req.body);\n            res.status(204).end();\n        } catch(err) {\n            next(err);\n        }    \n    },\n\n    async unsubscribe(req, res, next) {\n        if(isUserNotExist(req.params.id))\n            return next(new ApiError.NotFound('User'));\n\n        await PushNotification.find({ relatedUser: req.user.id}).remove();\n\n        req.status(204).end();\n    }\n}\n\n"]}