{"version":3,"sources":["../../src/controllers/user.controller.js"],"names":["jwtSecret","generateToken","sign","sub","id","iss","iat","Date","getTime","expiresIn","validateSignUpBody","req","checkBody","notEmpty","withMessage","custom","findOne","email","value","then","user","Error","getValidationResult","signUp","res","next","result","isEmpty","mapped","img","body","create","save","status","send","token","signIn"],"mappings":";;;;;;AAAA;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;;;IAEQA,S,oBAAAA,S;;;AAGR,IAAMC,gBAAgB,SAAhBA,aAAgB,KAAM;;AAExB,WAAO,uBAAIC,IAAJ,CAAS;AACZC,aAAKC,EADO;AAEZC,aAAK,KAFO;AAGZC,aAAK,IAAIC,IAAJ,GAAWC,OAAX,EAHO;AAIZC,mBAAW;AAJC,KAAT,EAKJT,SALI,CAAP;AAMH,CARD;;AAWA,IAAMU,qBAAqB,SAArBA,kBAAqB,MAAO;;AAE9BC,QAAIC,SAAJ,CAAc,OAAd,EAAuBC,QAAvB,GAAkCC,WAAlC,CAA8C,gBAA9C,EACKC,MADL,CACY,iBAAS;AACb,eAAO,eAAKC,OAAL,CAAa,EAAEC,OAAOC,KAAT,EAAb,EAA+BC,IAA/B,CAAoC,gBAAQ;AAC/C,gBAAIC,IAAJ,EACI,MAAM,IAAIC,KAAJ,CAAU,YAAV,CAAN;AACP,SAHM,CAAP;AAIH,KANL,EAMOP,WANP,CAMmB,YANnB;;AAQAH,QAAIC,SAAJ,CAAc,UAAd,EAA0BC,QAA1B,GAAqCC,WAArC,CAAiD,mBAAjD;AACAH,QAAIC,SAAJ,CAAc,OAAd,EAAuBC,QAAvB,GAAkCC,WAAlC,CAA8C,gBAA9C;AACAH,QAAIC,SAAJ,CAAc,UAAd,EAA0BC,QAA1B,GAAqCC,WAArC,CAAiD,mBAAjD;AACAH,QAAIC,SAAJ,CAAc,SAAd,EAAyBC,QAAzB,GAAoCC,WAApC,CAAgD,kBAAhD;AACA,WAAOH,IAAIW,mBAAJ,EAAP;AACH,CAfD;;kBAkBe;AAELC,UAFK,kBAEEZ,GAFF,EAEOa,GAFP,EAEYC,IAFZ,EAEkB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAENf,mBAAmBC,GAAnB,CAFM;;AAAA;AAErBe,kCAFqB;;;AAIzB,gCAAI,CAACA,OAAOC,OAAP,EAAL,EACIF,KAAK,uBAAa,GAAb,EAAkBC,OAAOE,MAAP,EAAlB,CAAL,EADJ,KAEK;AAEGC,mCAFH,GAESlB,IAAImB,IAAJ,CAASD,GAFlB;;AAGD,uCAAOlB,IAAImB,IAAJ,CAASD,GAAhB;;AAEA,+CAAKE,MAAL,CAAYpB,IAAImB,IAAhB,EAAsBX,IAAtB,CAA2B,gBAAQ;;AAE/B,wCAAIf,KAAKgB,KAAKhB,EAAd;AACA,wCAAIyB,GAAJ,EAAS;AACLT,6CAAKS,GAAL,GAAW,oCAAwB,WAASA,GAAjC,EAAsCzB,EAAtC,EAA0CO,GAA1C,CAAX;AACAS,6CAAKY,IAAL;AACH;;AAGDR,wCAAIS,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEd,UAAF,EAAQe,OAAOlC,cAAcG,EAAd,CAAf,EAArB;AACH,iCAVD;AAWH;;AAtBwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAwB5B,KA1BU;AA6BLgC,UA7BK,kBA6BEzB,GA7BF,EA6BOa,GA7BP,EA6BYC,IA7BZ,EA6BkB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAErBL,gCAFqB,GAEdT,IAAIS,IAFU;;AAGzBI,gCAAIS,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEd,UAAF,EAAQe,OAAOlC,cAAcmB,KAAKhB,EAAnB,CAAf,EAArB;;AAHyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAI5B;AAjCU,C","file":"user.controller.js","sourcesContent":["import User from \"../models/user.model\";\n\nimport ApiError from \"../helpers/ApiError\";\nimport jwt from \"jsonwebtoken\";\nimport config from \"../config\";\nimport { writeBase64AndReturnUrl } from \"../utils\";\n\nconst { jwtSecret } = config;\n\n\nconst generateToken = id => {\n\n    return jwt.sign({\n        sub: id,\n        iss: 'App',\n        iat: new Date().getTime(),\n        expiresIn: 604800000\n    }, jwtSecret)\n}\n\n\nconst validateSignUpBody = req => {\n\n    req.checkBody(\"email\").notEmpty().withMessage(\"Email Required\")\n        .custom(value => {\n            return User.findOne({ email: value }).then(user => {\n                if (user)\n                    throw new Error(\"Duplicated\");\n            })\n        }).withMessage(\"Duplicated\");\n\n    req.checkBody(\"password\").notEmpty().withMessage(\"Password required\");\n    req.checkBody(\"phone\").notEmpty().withMessage(\"Phone required\");\n    req.checkBody(\"fullName\").notEmpty().withMessage(\"FullName required\");\n    req.checkBody(\"country\").notEmpty().withMessage(\"Country required\");\n    return req.getValidationResult();\n}\n\n\nexport default {\n\n    async signUp(req, res, next) {\n\n        let result = await validateSignUpBody(req);\n\n        if (!result.isEmpty())\n            next(new ApiError(422, result.mapped()));\n        else {\n\n            let img = req.body.img;\n            delete req.body.img;\n\n            User.create(req.body).then(user => {\n\n                let id = user.id;\n                if (img) {\n                    user.img = writeBase64AndReturnUrl(\"users/\"+img, id, req);\n                    user.save();\n                }\n\n\n                res.status(201).send({ user, token: generateToken(id) });\n            });\n        }\n\n    },\n\n\n    async signIn(req, res, next) {\n\n        let user = req.user;\n        res.status(200).send({ user, token: generateToken(user.id) });\n    }\n}"]}