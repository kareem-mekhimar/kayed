{"version":3,"sources":["../../src/controllers/auction.controller.js"],"names":["validateAuctionBody","req","checkBody","notEmpty","withMessage","custom","findById","value","then","user","Error","category","matches","getValidationResult","findAll","res","next","page","query","limit","startPrice","endPrice","finished","findQuery","find","countQuery","count","where","equals","gte","lte","populate","parseInt","sort","creationDate","skip","results","pageCount","Math","ceil","response","addSelfLink","addPrevLink","addNextLink","send","id","params","auction","toJSON","relatedAuction","offersCount","price","topAuctionOffers","topBids","length","i","bidderName","bidder","fullName","bidderImg","img","create","result","isEmpty","mapped","imgs","body","highestPrice","url","Date","getTime","push","save","status","delete","remove","end"],"mappings":"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","file":"auction.controller.js","sourcesContent":["import Auction from \"../models/auction.model\";\nimport AuctionOffer from \"../models/auction-offer.model\"\nimport User from \"../models/user.model\";\nimport Category from \"../models/category.model\";\nimport ApiResponse from \"../helpers/ApiResponse\";\nimport ApiError from \"../helpers/ApiError\";\n\n\nimport { writeBase64AndReturnUrl } from \"../utils\";\n\n\nconst validateAuctionBody = req => {\n\n    req.checkBody(\"relatedUser\").notEmpty().withMessage(\"relatedUser Required\")\n        .custom(value => {\n            return User.findById(value).then(user => {\n                if (!user)\n                    throw new Error(\"Related user Is Not Found\");\n            })\n        }).withMessage(\"relatedUser is Not Found in the system\");\n\n    req.checkBody(\"relatedCategory\").notEmpty().withMessage(\"relatedCategory Required\")\n        .custom(value => {\n            return Category.findById(value).then(category => {\n                if (!category)\n                    throw new Error(\"Related category Is Not Found\");\n            })\n        }).withMessage(\"relatedCategory is Not Found in the system\");\n\n    req.checkBody(\"title\").notEmpty().withMessage(\"title required\");\n    req.checkBody(\"description\").notEmpty().withMessage(\"Description required\");\n    req.checkBody(\"endDate\").notEmpty().withMessage(\"endDate required\");\n    req.checkBody(\"startPrice\").notEmpty().withMessage(\"startPrice required\").matches(/\\d/).withMessage(\"Invalid Number\");\n    req.checkBody(\"imgs\").notEmpty().withMessage(\"Provide at least one image\");\n\n    return req.getValidationResult();\n}\n\n\nexport default {\n\n    async findAll(req, res, next) {\n        let page = req.query.page;\n        let limit = req.query.limit;\n        let category = req.query.category;\n        let startPrice = req.query.startPrice;\n        let endPrice = req.query.endPrice;\n        let finished = req.query.finished;\n\n        if (startPrice && endPrice) {\n            if (endPrice < startPrice)\n                return next(new ApiError(400, \"startPrice Can't be more than endPrice\"));\n        }\n\n\n        let findQuery = Auction.find({});\n        let countQuery = Auction.count();\n\n        if (category) {\n            findQuery.where(\"relatedCategory\").equals(category);\n            countQuery.where(\"relatedCategory\").equals(category);\n        }\n\n        if (startPrice) {\n            findQuery.where(\"highestPrice\").gte(startPrice);\n            countQuery.where(\"highestPrice\").gte(startPrice);\n        }\n\n\n        if (endPrice) {\n            findQuery.where(\"highestPrice\").lte(endPrice);\n            countQuery.where(\"highestPrice\").gte(endPrice);\n        }\n\n\n        if (typeof finished !== 'undefined') {\n            findQuery.where(\"finished\").equals(finished);\n            countQuery.where(\"finished\").equals(finished)\n        }\n\n        findQuery.populate('relatedUser relatedCategory');\n\n        page = page ? parseInt(page) : 1;\n        limit = limit ? limit : 20;\n\n        let results = await findQuery.sort({ creationDate: -1 })\n            .limit(parseInt(limit))\n            .skip((page - 1) * limit);\n\n        let count = await countQuery\n\n        let pageCount = Math.ceil(count / limit);\n        let response = new ApiResponse(results, page, pageCount, limit, count);\n\n        response.addSelfLink(req);\n\n        if (page > 1) {\n            response.addPrevLink(req);\n        }\n        if (page < pageCount) {\n            response.addNextLink(req);\n        }\n\n        res.send(response);\n\n    },\n\n    async findById(req, res, next) {\n\n        let id = req.params.id;\n        let auction = await Auction.findById(id).populate('relatedUser relatedCategory');\n\n        if (!auction) {\n            next(new ApiError(404, \"Auction with this id not found\"));\n        } else {\n\n            auction = { ...auction.toJSON() }\n            let count  = await AuctionOffer.count({ relatedAuction: id }) ;\n            auction.offersCount = count ;\n\n\n            let topAuctionOffers = await AuctionOffer.find({ relatedAuction: id }).sort({ price: -1 }).limit(3).populate(\"bidder\");\n            let topBids = {}\n            if (topAuctionOffers && topAuctionOffers.length > 0) {\n                for (let i = 0 ; i < topAuctionOffers.length ; i++) {       \n                    topBids[i+1] = { \n                        bidderName: topAuctionOffers[i].bidder.fullName,\n                        bidderImg: topAuctionOffers[i].bidder.img ,\n                        price: topAuctionOffers[i].price\n                     }\n                }\n\n                auction.topBids = topBids ;\n            }\n            \n            res.send(auction)\n        }\n    },\n\n    async create(req, res, next) {\n\n        let result = await validateAuctionBody(req);\n\n        if (!result.isEmpty())\n            next(new ApiError(422, result.mapped()));\n        else {\n\n            try {\n                let imgs = req.body.imgs;\n                delete req.body.imgs;\n\n                req.body.highestPrice = req.body.startPrice;\n\n                let auction = await Auction.create(req.body);\n\n                for (let i = 0; i < imgs.length; i++) {\n                    let url = writeBase64AndReturnUrl(imgs[i], \"auctions/\" + auction.id + new Date().getTime(), req);\n                    auction.imgs.push(url);\n                }\n\n                await auction.save();\n\n                res.status(201).send(auction);\n\n            } catch (error) {\n                next(error)\n            }\n        }\n\n    },\n\n    async delete(req, res, next) {\n        let id = req.params.id;\n\n        let auction = await Auction.findById(id);\n\n        if (!auction)\n            next(new ApiError(404, \"Auction with this id not found\"));\n        else {\n            auction.remove();\n            res.status(204).end();\n        }\n\n    },\n\n}"]}